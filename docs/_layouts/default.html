<!DOCTYPE html>
<html lang="{{ site.lang | default: 'en-US' }}">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

{% seo %}
    <link rel="stylesheet" href="{{ '/assets/css/style.css?v=' | append: site.github.build_revision | relative_url }}">
    <link rel="icon" type="image/png" href="{{ '/lora_craft.png' | relative_url }}">
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
    {% include head-custom.html %}
  </head>
  <body>
    <!-- Mobile Header (visible only on mobile) -->
    <header class="mobile-header">
      <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Toggle Menu">
        <span class="hamburger-icon">
          <span></span>
          <span></span>
          <span></span>
        </span>
      </button>
      <div class="mobile-header-content">
        <img src="{{ '/lora_craft.png' | relative_url }}" alt="LoRA Craft" class="mobile-logo">
        <span class="mobile-title">LoRA Craft</span>
      </div>
    </header>

    <!-- Sidebar Toggle Button (desktop only) -->
    <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle Sidebar">
      <span class="toggle-icon">â˜°</span>
    </button>

    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <img src="{{ '/lora_craft.png' | relative_url }}" alt="LoRA Craft" class="sidebar-logo">
        <h2 class="sidebar-title">LoRA Craft</h2>
        <p class="sidebar-tagline">Fine-tuning with GRPO</p>
      </div>

      <nav class="sidebar-nav" id="sidebar-nav">
        <!-- TOC will be injected here by JavaScript -->
      </nav>
    </aside>

    <!-- Main Content -->
    <div id="main-container" class="main-container">
      <a id="skip-to-content" href="#content">Skip to the content.</a>

      <main id="content" class="main-content" role="main">
        {{ content }}

        <footer class="site-footer">
          {% if site.github.is_project_page %}
            <span class="site-footer-owner"><a href="{{ site.github.repository_url }}">{{ site.github.repository_name }}</a> is maintained by <a href="{{ site.github.owner_url }}">{{ site.github.owner_name }}</a>.</span>
          {% endif %}
          <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
        </footer>
      </main>
    </div>

    <script>
      // ========================================================================
      // Sidebar Functionality
      // ========================================================================

      (function() {
        const sidebar = document.getElementById('sidebar');
        const mainContainer = document.getElementById('main-container');
        const toggleBtn = document.getElementById('sidebar-toggle');
        const sidebarNav = document.getElementById('sidebar-nav');

        // Mobile menu toggle
        const mobileToggle = document.getElementById('mobile-menu-toggle');

        // Check saved state
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (sidebarCollapsed) {
          sidebar.classList.add('collapsed');
          mainContainer.classList.add('sidebar-collapsed');
        }

        // Toggle sidebar (desktop)
        toggleBtn.addEventListener('click', function() {
          const isCollapsed = sidebar.classList.toggle('collapsed');
          mainContainer.classList.toggle('sidebar-collapsed');
          localStorage.setItem('sidebarCollapsed', isCollapsed);
        });

        // Toggle sidebar (mobile)
        if (mobileToggle) {
          mobileToggle.addEventListener('click', function() {
            const isCollapsed = sidebar.classList.toggle('collapsed');
            mainContainer.classList.toggle('sidebar-collapsed');
            this.classList.toggle('active');
          });
        }

        // ========================================================================
        // Generate Table of Contents
        // ========================================================================

        function generateTOC() {
          const content = document.querySelector('.main-content');
          const headings = content.querySelectorAll('h2, h3');
          const toc = document.createElement('ul');
          toc.className = 'toc-list';

          let currentH2 = null;

          headings.forEach((heading, index) => {
            // Skip the "Table of Contents" heading itself
            if (heading.textContent.trim() === 'Table of Contents') {
              return;
            }

            const li = document.createElement('li');
            const a = document.createElement('a');

            // Create ID if it doesn't exist
            if (!heading.id) {
              heading.id = 'heading-' + index;
            }

            a.href = '#' + heading.id;
            a.textContent = heading.textContent;
            a.className = 'toc-link';

            if (heading.tagName === 'H2') {
              li.className = 'toc-item toc-h2';
              li.appendChild(a);
              toc.appendChild(li);
              currentH2 = li;
            } else if (heading.tagName === 'H3' && currentH2) {
              let sublist = currentH2.querySelector('.toc-sublist');
              if (!sublist) {
                sublist = document.createElement('ul');
                sublist.className = 'toc-sublist';
                currentH2.appendChild(sublist);
              }
              li.className = 'toc-item toc-h3';
              li.appendChild(a);
              sublist.appendChild(li);
            }
          });

          sidebarNav.appendChild(toc);
        }

        // ========================================================================
        // Active Section Highlighting
        // ========================================================================

        function updateActiveSection() {
          const headings = document.querySelectorAll('.main-content h2, .main-content h3');
          const tocLinks = document.querySelectorAll('.toc-link');

          let currentActive = null;
          const scrollPos = window.scrollY + 100; // Offset for better UX

          headings.forEach(heading => {
            if (heading.offsetTop <= scrollPos) {
              currentActive = heading.id;
            }
          });

          tocLinks.forEach(link => {
            const href = link.getAttribute('href').substring(1);
            if (href === currentActive) {
              link.classList.add('active');
            } else {
              link.classList.remove('active');
            }
          });
        }

        // ========================================================================
        // Smooth Scrolling
        // ========================================================================

        function enableSmoothScrolling() {
          document.querySelectorAll('.toc-link').forEach(link => {
            link.addEventListener('click', function(e) {
              e.preventDefault();
              const targetId = this.getAttribute('href').substring(1);
              const target = document.getElementById(targetId);
              if (target) {
                const offset = 80; // Account for header
                const targetPos = target.offsetTop - offset;
                window.scrollTo({
                  top: targetPos,
                  behavior: 'smooth'
                });

                // On mobile, close the sidebar after clicking a link
                if (window.innerWidth < 768) {
                  sidebar.classList.add('collapsed');
                  mainContainer.classList.add('sidebar-collapsed');
                  if (mobileToggle) {
                    mobileToggle.classList.remove('active');
                  }
                }
              }
            });
          });
        }

        // ========================================================================
        // Initialize
        // ========================================================================

        // Wait for content to load
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }

        function init() {
          generateTOC();
          enableSmoothScrolling();
          updateActiveSection();

          // Update active section on scroll (throttled)
          let scrollTimeout;
          window.addEventListener('scroll', function() {
            if (scrollTimeout) {
              clearTimeout(scrollTimeout);
            }
            scrollTimeout = setTimeout(updateActiveSection, 50);
          });

          // Auto-collapse sidebar on mobile
          if (window.innerWidth < 768) {
            sidebar.classList.add('collapsed');
            mainContainer.classList.add('sidebar-collapsed');
          }

          // Close sidebar when clicking outside on mobile
          document.addEventListener('click', function(e) {
            if (window.innerWidth < 768) {
              const clickedOutside = !sidebar.contains(e.target) &&
                                    !mobileToggle.contains(e.target);
              if (clickedOutside && !sidebar.classList.contains('collapsed')) {
                sidebar.classList.add('collapsed');
                mainContainer.classList.add('sidebar-collapsed');
                if (mobileToggle) {
                  mobileToggle.classList.remove('active');
                }
              }
            }
          });

          // Handle window resize
          let resizeTimeout;
          window.addEventListener('resize', function() {
            if (resizeTimeout) {
              clearTimeout(resizeTimeout);
            }
            resizeTimeout = setTimeout(function() {
              if (window.innerWidth < 768 && !sidebar.classList.contains('collapsed')) {
                sidebar.classList.add('collapsed');
                mainContainer.classList.add('sidebar-collapsed');
                if (mobileToggle) {
                  mobileToggle.classList.remove('active');
                }
              }
            }, 100);
          });
        }
      })();
    </script>
  </body>
</html>
