<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoRA Craft</title>

    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" sizes="64x64" href="{{ url_for('static', filename='images/lora_craft.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/lora_craft.png') }}">
    <meta name="theme-color" content="#6366f1">

    <!-- PWA Manifest (optional) -->
    <link rel="manifest" href="/manifest.json">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Chart.js for metrics -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">

    <!-- Style -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/rewards.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Unified Header -->
    <header class="unified-header">
        <!-- Main Header Row -->
        <div class="header-main">
            <!-- Left: Brand -->
            <div class="header-brand">
                <img src="{{ url_for('static', filename='images/lora_craft.png') }}" alt="LoRA Craft" class="header-icon" onclick="showAppInfo()" data-bs-toggle="tooltip" title="Click for app info">
                <span class="header-title">LoRA Craft</span>
            </div>

            <!-- Center: Workflow Progress -->
            <div class="header-progress">
                <div class="compact-progress-steps">
                    <div class="compact-step active" id="step-1-indicator" onclick="goToStep(1)" data-bs-toggle="tooltip" title="Model Configuration">
                        <i class="fas fa-brain"></i>
                        <span>Model</span>
                    </div>
                    <div class="step-connector"></div>
                    <div class="compact-step" id="step-2-indicator" onclick="goToStep(2)" data-bs-toggle="tooltip" title="Dataset & Prompts">
                        <i class="fas fa-database"></i>
                        <span>Dataset</span>
                    </div>
                    <div class="step-connector"></div>
                    <div class="compact-step" id="step-3-indicator" onclick="goToStep(3)" data-bs-toggle="tooltip" title="Configuration">
                        <i class="fas fa-sliders-h"></i>
                        <span>Config</span>
                    </div>
                    <div class="step-connector"></div>
                    <div class="compact-step" id="step-4-indicator" onclick="goToStep(4)" data-bs-toggle="tooltip" title="Review & Train">
                        <i class="fas fa-dumbbell"></i>
                        <span>Train</span>
                    </div>
                    <div class="step-connector"></div>
                    <div class="compact-step" id="step-5-indicator" onclick="goToStep(5); setTimeout(() => refreshTrainedModels(), 100);" data-bs-toggle="tooltip" title="Model Exports">
                        <i class="fas fa-file-export"></i>
                        <span>Export</span>
                    </div>
                    <div class="step-connector"></div>
                    <div class="compact-step" id="step-6-indicator" onclick="goToStep(6); setTimeout(() => loadTestableModels(), 100);" data-bs-toggle="tooltip" title="Test Model">
                        <i class="fas fa-vial"></i>
                        <span>Test</span>
                    </div>
                    <div class="step-connector"></div>
                    <div class="compact-step" id="step-7-indicator" onclick="goToStep(7);" data-bs-toggle="tooltip" title="Evaluate Model">
                        <i class="fas fa-chart-line"></i>
                        <span>Evaluate</span>
                    </div>
                </div>
            </div>

            <!-- Right: Actions -->
            <div class="header-actions">
                <button class="action-btn" onclick="toggleTheme()" data-bs-toggle="tooltip" title="Toggle Theme">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
                <button class="action-btn" onclick="showHelp()" data-bs-toggle="tooltip" title="Help">
                    <i class="fas fa-question-circle"></i>
                </button>
                <button class="action-btn" onclick="toggleSidebar()" data-bs-toggle="tooltip" title="Toggle Sidebar">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>

        <!-- Status Bar Row -->
        <div class="header-status">
            <div class="status-indicators">
                <div class="status-indicator" data-bs-toggle="tooltip" title="GPU Status">
                    <i class="fas fa-microchip"></i>
                    <span class="indicator-value" id="gpu-status">--</span>
                </div>
                <div class="status-indicator" data-bs-toggle="tooltip" title="VRAM Available">
                    <i class="fas fa-microchip"></i>
                    <span class="indicator-value" id="vram-status">--</span>
                </div>
                <div class="status-indicator" data-bs-toggle="tooltip" title="RAM Available">
                    <i class="fas fa-memory"></i>
                    <span class="indicator-value" id="ram-status">--</span>
                </div>
                <div class="status-indicator" data-bs-toggle="tooltip" title="Connection Status">
                    <i class="fas fa-wifi"></i>
                    <span class="indicator-dot online" id="connection-indicator"></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Wrapper with Flexbox Layout -->
    <div class="main-wrapper">
        <!-- Sidebar Panel -->
        <aside class="sidebar-panel" id="sidebar-panel">
                <div class="sidebar-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-history"></i> Training Sessions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="sessions-list" class="sessions-list">
                            <!-- Sessions will be populated here -->
                        </div>
                        <button class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="refreshSessions()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="sidebar-card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cog"></i> Config Manager
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label small">Saved Configurations</label>
                            <select id="saved-configs-list" class="form-select form-select-sm" onchange="onConfigSelect()">
                                <option value="">Select a config...</option>
                            </select>
                        </div>
                        <button class="btn btn-primary w-100 mb-2" onclick="saveConfig()">
                            <i class="fas fa-save"></i> Save Current Config
                        </button>
                        <button class="btn btn-outline-primary w-100 mb-2" onclick="loadSelectedConfig()">
                            <i class="fas fa-folder-open"></i> Load Selected
                        </button>
                        <button class="btn btn-outline-danger w-100" onclick="deleteSelectedConfig()">
                            <i class="fas fa-trash"></i> Delete Selected
                        </button>
                    </div>
                </div>
        </aside>

        <!-- Content Area -->
        <main class="content-area">
            <div class="content-container">
                <!-- Step 1: Model Configuration -->
                <div class="workflow-step" id="step-1">
                    <div class="step-card">
                        <div class="step-header" onclick="toggleStep(1)">
                            <div class="d-flex align-items-center">
                                <span class="step-number">1</span>
                                <h4 class="step-title">Model Configuration</h4>
                                <span class="step-status ms-auto">
                                    <i class="fas fa-chevron-up" id="step-1-chevron"></i>
                                </span>
                            </div>
                        </div>
                        <div class="step-content collapse show" id="step-1-content">
                            <!-- Quick Setup Options -->
                            <div class="quick-setup mb-4">
                                <label class="form-label fw-bold">Quick Setup</label>
                                <div class="selection-cards cols-3">
                                    <input type="radio" class="selection-input" name="setup-mode" id="setup-recommended" checked>
                                    <label class="selection-card" for="setup-recommended">
                                        <i class="fas fa-star"></i>
                                        <span>Recommended</span>
                                        <small>Best defaults</small>
                                    </label>
                                    <input type="radio" class="selection-input" name="setup-mode" id="setup-custom">
                                    <label class="selection-card" for="setup-custom">
                                        <i class="fas fa-cog"></i>
                                        <span>Custom</span>
                                        <small>Configure LoRA</small>
                                    </label>
                                    <input type="radio" class="selection-input" name="setup-mode" id="setup-advanced">
                                    <label class="selection-card" for="setup-advanced">
                                        <i class="fas fa-code"></i>
                                        <span>Advanced</span>
                                        <small>Full control</small>
                                    </label>
                                </div>
                            </div>

                            <!-- Model Selection -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Model Family</label>
                                        <select class="form-select" id="model-family" onchange="updateModelList(); updateConfigSummary();">
                                            <option value="qwen">Qwen3</option>
                                            <option value="llama">LLaMA 3.2</option>
                                            <option value="phi">Phi-4</option>
                                        </select>
                                        <small class="text-muted">Choose the base model architecture</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Model Size</label>
                                        <select class="form-select" id="model-name">
                                            <!-- Populated dynamically -->
                                        </select>
                                        <small class="text-muted">Smaller models train faster</small>
                                    </div>
                                </div>
                            </div>

                            <!-- LoRA Configuration (Hidden for Recommended mode) -->
                            <div class="config-section mt-4" id="lora-config-section" style="display: none;">
                                <h5 class="section-title">
                                    <i class="fas fa-layer-group"></i> LoRA Configuration
                                </h5>

                                <!-- LoRA Presets (for Custom mode) -->
                                <div id="lora-presets" class="mb-3" style="display: none;">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyLoRAPreset('low')">
                                            <i class="fas fa-memory"></i> Low VRAM
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyLoRAPreset('balanced')">
                                            <i class="fas fa-balance-scale"></i> Balanced
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyLoRAPreset('quality')">
                                            <i class="fas fa-gem"></i> High Quality
                                        </button>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="form-label">Rank (r) <i class="fas fa-question-circle text-muted" data-bs-toggle="tooltip" title="Higher rank = more parameters to train"></i></label>
                                            <input type="range" class="form-range" id="lora-rank-slider" min="4" max="128" value="16" onchange="updateValue('lora-rank', this.value); updateConfigSummary();">
                                            <input type="number" class="form-control" id="lora-rank" value="16" min="4" max="128">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="form-label">Alpha <i class="fas fa-question-circle text-muted" data-bs-toggle="tooltip" title="Scaling factor, typically 2x rank"></i></label>
                                            <input type="range" class="form-range" id="lora-alpha-slider" min="8" max="256" value="32" onchange="updateValue('lora-alpha', this.value); updateConfigSummary();">
                                            <input type="number" class="form-control" id="lora-alpha" value="32" min="8" max="256">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="form-label">Dropout <i class="fas fa-question-circle text-muted" data-bs-toggle="tooltip" title="Regularization to prevent overfitting"></i></label>
                                            <input type="range" class="form-range" id="lora-dropout-slider" min="0" max="0.5" step="0.05" value="0.05" onchange="updateValue('lora-dropout', this.value); updateConfigSummary();">
                                            <input type="number" class="form-control" id="lora-dropout" value="0.05" min="0" max="0.5" step="0.05">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced Configuration (Hidden by default) -->
                            <div class="config-section mt-4" id="advanced-config-section" style="display: none;">
                                <h5 class="section-title">
                                    <i class="fas fa-code-branch"></i> Advanced Configuration
                                </h5>

                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Custom Model Path</label>
                                            <input type="text" class="form-control" id="custom-model-path" placeholder="e.g., username/model-name or local path">
                                            <small class="text-muted">Leave empty to use selected model above</small>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Target Modules</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="target-q-proj" checked>
                                                <label class="form-check-label" for="target-q-proj">q_proj</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="target-v-proj" checked>
                                                <label class="form-check-label" for="target-v-proj">v_proj</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="target-k-proj">
                                                <label class="form-check-label" for="target-k-proj">k_proj</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="target-o-proj">
                                                <label class="form-check-label" for="target-o-proj">o_proj</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Quantization</label>
                                            <select class="form-select" id="quantization">
                                                <option value="none">None (Full Precision F32)</option>
                                                <option value="f16">Half Precision (F16)</option>
                                                <option value="q8_0" selected>8-bit Quantization (Q8_0)</option>
                                                <option value="auto">Auto (Let converter decide)</option>
                                            </select>
                                        </div>
                                        <div class="form-group mt-3">
                                            <label class="form-label">LoRA Bias</label>
                                            <select class="form-select" id="lora-bias">
                                                <option value="none" selected>None</option>
                                                <option value="all">All</option>
                                                <option value="lora_only">LoRA Only</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step Navigation -->
                            <div class="step-navigation mt-4">
                                <button class="btn btn-primary ms-auto" onclick="validateAndProceed(1)">
                                    Continue <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Dataset & Prompts -->
                <div class="workflow-step" id="step-2">
                    <div class="step-card">
                        <div class="step-header" onclick="toggleStep(2)">
                            <div class="d-flex align-items-center">
                                <span class="step-number">2</span>
                                <h4 class="step-title">Dataset & Prompts</h4>
                                <span class="step-status ms-auto">
                                    <i class="fas fa-chevron-down" id="step-2-chevron"></i>
                                </span>
                            </div>
                        </div>
                        <div class="step-content collapse" id="step-2-content">
                            <!-- Dataset Source -->
                            <div class="dataset-selection mb-4">
                                <label class="form-label fw-bold">Dataset Source</label>
                                <div class="selection-cards cols-3">
                                    <div class="selection-card" onclick="selectDatasetType('popular')" id="dataset-popular">
                                        <i class="fas fa-star"></i>
                                        <span>Public Datasets</span>
                                        <small>Browse available datasets</small>
                                    </div>
                                    <div class="selection-card" onclick="selectDatasetType('custom')" id="dataset-custom">
                                        <i class="fab fa-github"></i>
                                        <span>Custom HF Dataset</span>
                                        <small>Any HuggingFace dataset</small>
                                    </div>
                                    <div class="selection-card" onclick="selectDatasetType('upload')" id="dataset-upload">
                                        <i class="fas fa-upload"></i>
                                        <span>Upload File</span>
                                        <small>Use your own data</small>
                                    </div>
                                </div>
                            </div>


                            <!-- Dataset Configuration -->
                            <div id="dataset-config" style="display: none;">
                                <!-- Public Datasets Catalog -->
                                <div id="dataset-catalog" style="display: none;">
                                    <!-- Category Filter -->
                                    <div class="dataset-filters mb-3">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-secondary btn-sm active" onclick="filterDatasets('all')">All</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterDatasets('math')">Math</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterDatasets('coding')">Coding</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterDatasets('general')">General</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterDatasets('qa')">Q&A</button>
                                        </div>
                                    </div>

                                    <!-- Dataset Grid -->
                                    <div id="dataset-grid" class="dataset-grid">
                                        <!-- Populated by JavaScript -->
                                    </div>
                                </div>

                                <!-- Custom HuggingFace Dataset -->
                                <div id="dataset-custom-area" style="display: none;">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">
                                                <i class="fab fa-github"></i> Custom HuggingFace Dataset
                                            </h5>
                                            <p class="text-muted">Enter any HuggingFace dataset name to download and use</p>

                                            <div class="row g-3">
                                                <div class="col-md-8">
                                                    <input type="text" class="form-control" id="custom-dataset-name"
                                                           placeholder="e.g., tatsu-lab/alpaca, openai/gsm8k">
                                                    <small class="text-muted">Format: username/dataset-name or dataset-name</small>
                                                </div>
                                                <div class="col-md-4">
                                                    <input type="text" class="form-control" id="custom-dataset-config"
                                                           placeholder="Config (optional)">
                                                    <small class="text-muted">For multi-config datasets</small>
                                                </div>
                                            </div>

                                            <button class="btn btn-primary mt-3" onclick="downloadCustomDataset()">
                                                <i class="fas fa-download"></i> Download Dataset
                                            </button>

                                            <div class="alert alert-info mt-3">
                                                <i class="fas fa-info-circle"></i> The app will automatically detect the dataset fields and ask you to map them if needed.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Upload Dataset -->
                                <div id="dataset-upload-area" style="display: none;">
                                    <div class="upload-area">
                                        <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                                        <h5>Drop your dataset file here</h5>
                                        <p class="text-muted">or click to browse</p>
                                        <input type="file" id="dataset-file" accept=".json,.jsonl,.csv,.parquet" style="display: none;">
                                        <button class="btn btn-outline-primary" onclick="document.getElementById('dataset-file').click()">
                                            Browse Files
                                        </button>
                                    </div>
                                </div>

                                <!-- Selected Dataset Configuration -->
                                <div id="dataset-selected" class="mt-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="form-label">Selected Dataset</label>
                                                <input type="text" class="form-control" id="dataset-path" value="yahma/alpaca-cleaned" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="form-label">Split</label>
                                                <input type="text" class="form-control" id="dataset-split" value="train[:100]">
                                                <small class="text-muted">Limit samples for testing</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Field Mapping (auto-configured) -->
                                    <div class="field-mapping mt-3" id="field-mapping" style="display: none;">
                                        <label class="form-label">Field Mapping</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small class="text-muted">Instruction Field</small>
                                                <input type="text" class="form-control form-control-sm" id="instruction-field-visible" value="instruction">
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted">Response Field</small>
                                                <input type="text" class="form-control form-control-sm" id="response-field-visible" value="output">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- System Prompt -->
                            <div class="config-section mt-4">
                                <h5 class="section-title">
                                    <i class="fas fa-file-code"></i> System Prompt
                                </h5>
                                <div class="template-selector mb-3">
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="template-type" id="template-grpo" checked>
                                        <label class="btn btn-outline-primary" for="template-grpo">
                                            Default
                                        </label>
                                        <input type="radio" class="btn-check" name="template-type" id="template-custom">
                                        <label class="btn btn-outline-primary" for="template-custom">
                                            Custom
                                        </label>
                                    </div>
                                </div>

                                <!-- Template Editor (for Custom mode) -->
                                <div id="template-editor" style="display: none;">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Reasoning Start Marker</label>
                                            <input type="text" class="form-control" id="custom-reasoning-start" value="&lt;start_working_out&gt;" oninput="updateTemplatePreview()">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Reasoning End Marker</label>
                                            <input type="text" class="form-control" id="custom-reasoning-end" value="&lt;end_working_out&gt;" oninput="updateTemplatePreview()">
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Solution Start Marker</label>
                                            <input type="text" class="form-control" id="custom-solution-start" value="&lt;SOLUTION&gt;" oninput="updateTemplatePreview()">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Solution End Marker</label>
                                            <input type="text" class="form-control" id="custom-solution-end" value="&lt;/SOLUTION&gt;" oninput="updateTemplatePreview()">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">System Prompt</label>
                                        <textarea class="form-control" id="custom-system-prompt" rows="3" oninput="updateTemplatePreview()">You are given a problem.
Think about the problem and provide your working out.
Place it between &lt;start_working_out&gt; and &lt;end_working_out&gt;.
Then, provide your solution between &lt;SOLUTION&gt;&lt;/SOLUTION&gt;</textarea>
                                    </div>

                                    <div class="btn-group mb-3">
                                        <button class="btn btn-sm btn-outline-primary" onclick="testTemplate()">
                                            <i class="fas fa-vial"></i> Test Template
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="saveCustomTemplate()">
                                            <i class="fas fa-save"></i> Save Template
                                        </button>
                                    </div>

                                    <!-- Saved Templates List -->
                                    <div class="row mb-3">
                                        <div class="col-md-8">
                                            <select class="form-select form-select-sm" id="saved-templates-list">
                                                <option value="">Select a saved template...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-sm btn-outline-primary w-100" onclick="loadSelectedTemplate()">
                                                <i class="fas fa-folder-open"></i> Load Template
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Template Preview -->
                                <div class="template-preview-box">
                                    <div class="preview-header">
                                        <span>Template Preview</span>
                                        <div id="preview-actions" style="display: inline;">
                                            <button class="btn btn-sm btn-outline-light" id="edit-template-btn" onclick="editTemplate()" style="display: none;">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                        </div>
                                    </div>
                                    <pre id="template-preview" class="preview-content"></pre>
                                </div>

                                <!-- Chat Template Section -->
                                <div class="mt-4">
                                    <h6 class="mb-3"><i class="fas fa-comment-alt"></i> Chat Template</h6>

                                    <!-- Chat Template Presets -->
                                    <div class="mb-3">
                                        <label class="form-label">Template Type</label>
                                        <select class="form-select" id="chat-template-type" onchange="onChatTemplateTypeChange()">
                                            <option value="grpo">GRPO Default (Reasoning)</option>
                                            <option value="custom">Custom Template</option>
                                        </select>
                                    </div>

                                    <!-- Chat Template Editor (shown for Custom mode) -->
                                    <div id="chat-template-editor" style="display: none;">
                                        <div class="mb-3">
                                            <label class="form-label">Chat Template (Jinja2)</label>
                                            <textarea class="form-control font-monospace" id="custom-chat-template" rows="10" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off" oninput="validateChatTemplate()">{% raw %}{% if messages[0]['role'] == 'system' %}{{ messages[0]['content'] + eos_token }}{% set loop_messages = messages[1:] %}{% else %}{{ system_prompt + eos_token }}{% set loop_messages = messages %}{% endif %}{% for message in loop_messages %}{% if message['role'] == 'user' %}{{ message['content'] }}{% elif message['role'] == 'assistant' %}{{ message['content'] + eos_token }}{% endif %}{% endfor %}{% if add_generation_prompt %}{{ reasoning_start }}{% endif %}{% endraw %}</textarea>
                                            <small class="form-text text-muted">
                                                <i class="fas fa-info-circle"></i> Jinja2 template. Available variables: messages, system_prompt, eos_token, reasoning_start, add_generation_prompt
                                            </small>
                                            <div id="chat-template-validation" class="mt-2"></div>
                                        </div>

                                        <!-- Template Variables Helper -->
                                        <div class="alert alert-info">
                                            <h6><i class="fas fa-code"></i> Template Variables</h6>
                                            <small>
                                                <code>messages</code> - List of message dicts with 'role' and 'content'<br>
                                                <code>system_prompt</code> - System prompt text<br>
                                                <code>eos_token</code> - End of sequence token<br>
                                                <code>reasoning_start</code> - Start of reasoning marker<br>
                                                <code>add_generation_prompt</code> - True when generating
                                            </small>
                                        </div>

                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="validateChatTemplate()">
                                                <i class="fas fa-check"></i> Validate
                                            </button>
                                            <button class="btn btn-sm btn-outline-success" onclick="saveChatTemplate()">
                                                <i class="fas fa-save"></i> Save Template
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="loadChatTemplate()">
                                                <i class="fas fa-folder-open"></i> Load
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Pre-training Options -->
                                    <div class="mt-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enable-pre-training" checked>
                                            <label class="form-check-label" for="enable-pre-training">
                                                Enable Pre-training Phase
                                                <i class="fas fa-question-circle text-muted" data-bs-toggle="tooltip"
                                                   title="Pre-trains the model for 1-2 epochs to learn the template format before GRPO training"></i>
                                            </label>
                                        </div>
                                        <div class="ms-4 mt-2" id="pre-training-options">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-label small">Pre-training Epochs</label>
                                                    <input type="number" class="form-control form-control-sm" id="pre-training-epochs" value="1" min="1" max="3">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label small">Sample Size</label>
                                                    <input type="number" class="form-control form-control-sm" id="pre-training-samples" value="100" min="50" max="500">
                                                </div>
                                            </div>
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="checkbox" id="validate-format" checked>
                                                <label class="form-check-label small" for="validate-format">
                                                    Validate format compliance after pre-training
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Chat Template Preview -->
                                    <div class="template-preview-box mt-3">
                                        <div class="preview-header">
                                            <span>Chat Template Preview</span>
                                        </div>
                                        <pre id="chat-template-preview" class="preview-content" style="border-radius: 0 0 12px 12px;">Loading...</pre>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden template fields (keep existing functionality) -->
                            <input type="hidden" id="dataset-source" value="huggingface">
                            <input type="hidden" id="instruction-field" value="instruction">
                            <input type="hidden" id="response-field" value="output">
                            <input type="hidden" id="reasoning-start" value="<start_working_out>">
                            <input type="hidden" id="reasoning-end" value="<end_working_out>">
                            <input type="hidden" id="solution-start" value="<SOLUTION>">
                            <input type="hidden" id="solution-end" value="</SOLUTION>">
                            <textarea id="system-prompt" style="display:none;">You are given a problem.
Think about the problem and provide your working out.
Place it between <start_working_out> and <end_working_out>.
Then, provide your solution between <SOLUTION></SOLUTION></textarea>
                            <textarea id="chat-template" style="display:none;">{% raw %}{% if messages[0]['role'] == 'system' %}{{ messages[0]['content'] + eos_token }}{% set loop_messages = messages[1:] %}{% else %}{{ system_prompt + eos_token }}{% set loop_messages = messages %}{% endif %}{% for message in loop_messages %}{% if message['role'] == 'user' %}{{ message['content'] }}{% elif message['role'] == 'assistant' %}{{ message['content'] + eos_token }}{% endif %}{% endfor %}{% if add_generation_prompt %}{{ reasoning_start }}{% endif %}{% endraw %}</textarea>

                            <!-- Step Navigation -->
                            <div class="step-navigation mt-4">
                                <button class="btn btn-outline-secondary" onclick="goToStep(1)">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                                <button class="btn btn-primary ms-auto" onclick="validateAndProceed(2)">
                                    Continue <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Training Configuration -->
                <div class="workflow-step" id="step-3">
                    <div class="step-card">
                        <div class="step-header" onclick="toggleStep(3)">
                            <div class="d-flex align-items-center">
                                <span class="step-number">3</span>
                                <h4 class="step-title">Training Configuration</h4>
                                <span class="step-status ms-auto">
                                    <i class="fas fa-chevron-down" id="step-3-chevron"></i>
                                </span>
                            </div>
                        </div>
                        <div class="step-content collapse" id="step-3-content">
                            <!-- Training Presets -->
                            <div class="training-presets mb-4">
                                <label class="form-label fw-bold">Training Presets</label>
                                <div class="selection-cards cols-4">
                                    <div class="selection-card active" onclick="applyPreset('recommended')" id="preset-recommended">
                                        <i class="fas fa-magic"></i>
                                        <span>Recommended</span>
                                        <small>Auto-optimized</small>
                                    </div>
                                    <div class="selection-card" onclick="applyPreset('fast')" id="preset-fast">
                                        <i class="fas fa-bolt"></i>
                                        <span>Fast</span>
                                        <small>Quick testing</small>
                                    </div>
                                    <div class="selection-card" onclick="applyPreset('balanced')" id="preset-balanced">
                                        <i class="fas fa-balance-scale"></i>
                                        <span>Balanced</span>
                                        <small>General purpose</small>
                                    </div>
                                    <div class="selection-card" onclick="applyPreset('quality')" id="preset-quality">
                                        <i class="fas fa-gem"></i>
                                        <span>Quality</span>
                                        <small>Best results</small>
                                    </div>
                                </div>
                                <div id="preset-indicator" class="mt-2" style="display: none;">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> <span id="preset-message">Custom configuration applied</span>
                                    </small>
                                </div>
                                <div id="recommended-explanation" class="alert alert-info mt-2" style="display: none;">
                                    <i class="fas fa-lightbulb"></i>
                                    <small id="recommendation-details">Settings optimized based on your configuration</small>
                                </div>
                            </div>

                            <!-- Algorithm Type Selection -->
                            <div class="algorithm-selection mb-4">
                                <label class="form-label fw-bold">Algorithm Type</label>
                                <div class="selection-cards cols-3">
                                    <div class="selection-card active" onclick="selectAlgorithm('grpo')" id="algo-grpo">
                                        <i class="fas fa-chart-line"></i>
                                        <span>GRPO</span>
                                        <small>Token-level optimization</small>
                                    </div>
                                    <div class="selection-card" onclick="selectAlgorithm('gspo')" id="algo-gspo">
                                        <i class="fas fa-layer-group"></i>
                                        <span>GSPO</span>
                                        <small>Sequence-level optimization</small>
                                    </div>
                                    <div class="selection-card" onclick="selectAlgorithm('dr_grpo')" id="algo-dr_grpo">
                                        <i class="fas fa-shield-alt"></i>
                                        <span>DR-GRPO</span>
                                        <small>Doubly robust variant</small>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-2" id="algorithm-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>GRPO:</strong> Standard Group Relative Policy Optimization applies importance weights at the token level.
                                </div>
                            </div>

                            <!-- Algorithm-Specific Parameters (hidden by default) -->
                            <div class="config-section mb-4" id="gspo-params" style="display: none;">
                                <h5 class="section-title">
                                    <i class="fas fa-cog"></i> Algorithm-Specific Parameters
                                </h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Epsilon <small class="text-muted">(Lower bound)</small></label>
                                            <input type="number" class="form-control" id="epsilon" value="0.0003" step="0.0001">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Epsilon High <small class="text-muted">(Upper bound)</small></label>
                                            <input type="number" class="form-control" id="epsilon-high" value="0.0004" step="0.0001">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Reward Function Configuration -->
                            <div class="reward-configuration mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label class="form-label fw-bold mb-0">
                                        <i class="fas fa-trophy text-warning"></i> Reward Function
                                    </label>
                                    <button class="btn btn-sm btn-outline-info" onclick="showRewardHelp()">
                                        <i class="fas fa-question-circle"></i> Help
                                    </button>
                                </div>

                                <!-- Reward Mode Tabs -->
                                <ul class="nav nav-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#reward-templates-tab"
                                                type="button" role="tab">
                                            <i class="fas fa-rocket"></i> Quick Start
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reward-presets-tab"
                                                type="button" role="tab">
                                            <i class="fas fa-list-alt"></i> Preset Library
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reward-custom-tab"
                                                type="button" role="tab">
                                            <i class="fas fa-tools"></i> Custom Builder
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reward-test-tab"
                                                type="button" role="tab">
                                            <i class="fas fa-flask"></i> Test Reward
                                        </button>
                                    </li>
                                </ul>

                                <!-- Tab Content -->
                                <div class="tab-content p-3 border border-top-0">
                                    <!-- Quick Start Templates Tab -->
                                    <div class="tab-pane fade show active" id="reward-templates-tab" role="tabpanel">
                                        <div class="row" id="reward-templates-grid">
                                            <!-- Templates will be loaded dynamically -->
                                            <div class="col-md-4 mb-3">
                                                <div class="card template-card h-100" onclick="selectTemplate('math_problem_solving')">
                                                    <div class="card-body">
                                                        <h6 class="card-title">
                                                            <i class="fas fa-calculator text-primary"></i> Math Problems
                                                        </h6>
                                                        <p class="card-text small">Train models to solve mathematical problems with step-by-step solutions</p>
                                                        <div class="mt-auto">
                                                            <span class="badge bg-success">Popular</span>
                                                            <span class="badge bg-info">Beginner</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="card template-card h-100" onclick="selectTemplate('code_generation')">
                                                    <div class="card-body">
                                                        <h6 class="card-title">
                                                            <i class="fas fa-code text-success"></i> Code Generation
                                                        </h6>
                                                        <p class="card-text small">Generate clean, well-documented code with proper formatting</p>
                                                        <div class="mt-auto">
                                                            <span class="badge bg-success">Popular</span>
                                                            <span class="badge bg-warning">Intermediate</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="card template-card h-100" onclick="selectTemplate('question_answering')">
                                                    <div class="card-body">
                                                        <h6 class="card-title">
                                                            <i class="fas fa-comments text-info"></i> Q&A
                                                        </h6>
                                                        <p class="card-text small">Train models to provide accurate, concise answers to questions</p>
                                                        <div class="mt-auto">
                                                            <span class="badge bg-info">Beginner</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Preset Library Tab -->
                                    <div class="tab-pane fade" id="reward-presets-tab" role="tabpanel">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <h6>Categories</h6>
                                                <div class="list-group" id="preset-categories">
                                                    <!-- Categories will be loaded dynamically -->
                                                </div>
                                            </div>
                                            <div class="col-md-9">
                                                <div class="row" id="preset-list">
                                                    <!-- Presets will be loaded dynamically -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Custom Builder Tab -->
                                    <div class="tab-pane fade" id="reward-custom-tab" role="tabpanel">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> Build a custom reward by combining components. Each component evaluates a different aspect of the generated output.
                                        </div>
                                        <div id="reward-components-advanced">
                                            <!-- Components will be added here -->
                                        </div>
                                        <button class="btn btn-primary mt-3" onclick="addAdvancedComponent()">
                                            <i class="fas fa-plus"></i> Add Component
                                        </button>
                                        <button class="btn btn-success mt-3 ms-2" onclick="saveCustomReward()">
                                            <i class="fas fa-save"></i> Save Configuration
                                        </button>
                                    </div>

                                    <!-- Test Reward Tab -->
                                    <div class="tab-pane fade" id="reward-test-tab" role="tabpanel">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Test Input</h6>
                                                <div class="mb-3">
                                                    <label class="form-label">Instruction</label>
                                                    <textarea class="form-control" id="test-instruction" rows="2"
                                                              placeholder="e.g., Solve: 2x + 5 = 13"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Generated Response</label>
                                                    <textarea class="form-control" id="test-generated" rows="3"
                                                              placeholder="e.g., x = 4"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Reference (Optional)</label>
                                                    <textarea class="form-control" id="test-reference" rows="3"
                                                              placeholder="e.g., To solve: 2x = 8, x = 4\n\\boxed{4}"></textarea>
                                                </div>
                                                <button class="btn btn-primary" onclick="testReward()">
                                                    <i class="fas fa-play"></i> Test Reward
                                                </button>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Test Results</h6>
                                                <div id="test-results" class="p-3 bg-light rounded">
                                                    <p class="text-muted">Run a test to see results...</p>
                                                </div>
                                                <div id="reward-visualization" class="mt-3">
                                                    <!-- Chart will appear here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Enhanced Selected Reward Display Panel -->
                                <div class="selected-reward-panel">
                                    <div class="selected-reward-header">
                                        <i class="fas fa-check-circle text-success"></i>
                                        <strong>Currently Selected:</strong>
                                    </div>
                                    <div class="selected-reward-content">
                                        <h5 id="selected-reward-name">Mathematical Problem Solving</h5>
                                        <p id="selected-reward-description" class="text-muted small">
                                            Rewards accurate numerical answers with proper formatting (e.g., \boxed{} notation)
                                        </p>
                                        <div class="selected-reward-actions">
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewRewardDetails()">
                                                <i class="fas fa-info-circle"></i> View Details
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="testSelectedReward()">
                                                <i class="fas fa-flask"></i> Test
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Basic Settings -->
                            <div class="config-section">
                                <h5 class="section-title">
                                    <i class="fas fa-tachometer-alt"></i> Basic Settings
                                </h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="form-label">Epochs</label>
                                            <input type="number" class="form-control" id="num-epochs" value="3" min="1" max="100">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="form-label">Batch Size</label>
                                            <input type="number" class="form-control" id="batch-size" value="4" min="1" max="32" onchange="updateValidGenerations()">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="form-label">Generations <i class="fas fa-question-circle text-muted" data-bs-toggle="tooltip" title="Number of responses to generate per prompt (must divide batch size evenly)"></i></label>
                                            <select class="form-select" id="num-generations">
                                                <!-- Populated dynamically based on batch size -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="form-label">Learning Rate</label>
                                            <input type="number" class="form-control" id="learning-rate" value="0.0002" step="0.00001">
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="form-label">Gradient Accumulation <i class="fas fa-question-circle text-muted" data-bs-toggle="tooltip" title="Accumulate gradients over multiple steps"></i></label>
                                            <input type="number" class="form-control" id="gradient-accumulation" value="1" min="1" max="32">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="form-label">Max Sequence Length</label>
                                            <input type="number" class="form-control" id="max-sequence-length" value="2048" min="128" max="32768" step="128">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="form-label">Max New Tokens</label>
                                            <input type="number" class="form-control" id="max-new-tokens" value="256" min="32" max="2048" step="32">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="form-label">Warmup Steps</label>
                                            <input type="number" class="form-control" id="warmup-steps" value="10" min="0" max="1000">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="form-label">Weight Decay</label>
                                            <input type="number" class="form-control" id="weight-decay" value="0.001" min="0" max="1" step="0.001">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- GRPO Settings -->
                            <div class="config-section mt-4 collapsible">
                                <h5 class="section-title" onclick="toggleSection('grpo-settings')">
                                    <i class="fas fa-brain"></i> GRPO Settings
                                    <i class="fas fa-chevron-down float-end"></i>
                                </h5>
                                <div id="grpo-settings" class="section-content">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">Temperature</label>
                                                <input type="number" class="form-control" id="temperature" value="0.7" min="0.1" max="2.0" step="0.1">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">Top P</label>
                                                <input type="number" class="form-control" id="top-p" value="0.95" min="0" max="1" step="0.05">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">Top K</label>
                                                <input type="number" class="form-control" id="top-k" value="50" min="0" max="200" step="10">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">Repetition Penalty</label>
                                                <input type="number" class="form-control" id="repetition-penalty" value="1.0" min="0.5" max="2.0" step="0.1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">KL Penalty</label>
                                                <input type="number" class="form-control" id="kl-penalty" value="0.01" min="0" max="1" step="0.01">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">Clip Range</label>
                                                <input type="number" class="form-control" id="clip-range" value="0.2" min="0" max="1" step="0.05">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">Value Coefficient</label>
                                                <input type="number" class="form-control" id="value-coefficient" value="1.0" min="0" max="10" step="0.1">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Optimizations -->
                            <div class="config-section mt-4">
                                <h5 class="section-title">
                                    <i class="fas fa-dumbbell"></i> Optimizations
                                </h5>
                                <div class="optimization-toggles">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="use-flash-attention">
                                        <label class="form-check-label" for="use-flash-attention">
                                            Flash Attention <small class="text-muted">(Faster training)</small>
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="gradient-checkpointing">
                                        <label class="form-check-label" for="gradient-checkpointing">
                                            Gradient Checkpointing <small class="text-muted">(Less VRAM)</small>
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="mixed-precision" checked>
                                        <label class="form-check-label" for="mixed-precision">
                                            Mixed Precision (FP16) <small class="text-muted">(Recommended)</small>
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="use-bf16">
                                        <label class="form-check-label" for="use-bf16">
                                            Use BF16 <small class="text-muted">(Instead of FP16, for newer GPUs)</small>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced Training Settings (Collapsible) -->
                            <div class="config-section mt-4 collapsible">
                                <h5 class="section-title" onclick="toggleSection('advanced-training-settings')">
                                    <i class="fas fa-cogs"></i> Advanced Training Settings
                                    <i class="fas fa-chevron-down float-end"></i>
                                </h5>
                                <div id="advanced-training-settings" class="section-content" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="form-label">LR Scheduler Type</label>
                                                <select class="form-select" id="lr-scheduler-type">
                                                    <option value="constant" selected>Constant</option>
                                                    <option value="linear">Linear</option>
                                                    <option value="cosine">Cosine</option>
                                                    <option value="cosine_with_restarts">Cosine with Restarts</option>
                                                    <option value="polynomial">Polynomial</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="form-label">Optimizer</label>
                                                <select class="form-select" id="optimizer">
                                                    <option value="paged_adamw_32bit" selected>Paged AdamW 32-bit</option>
                                                    <option value="adamw_torch">AdamW (PyTorch)</option>
                                                    <option value="adamw_8bit">AdamW 8-bit</option>
                                                    <option value="sgd">SGD</option>
                                                    <option value="adafactor">Adafactor</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label class="form-label">Max Gradient Norm</label>
                                                <input type="number" class="form-control" id="max-grad-norm" value="0.3" min="0" max="10" step="0.1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">Logging Steps</label>
                                                <input type="number" class="form-control" id="logging-steps" value="10" min="1" max="1000">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">Save Steps</label>
                                                <input type="number" class="form-control" id="save-steps" value="100" min="10" max="10000">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">Eval Steps</label>
                                                <input type="number" class="form-control" id="eval-steps" value="100" min="10" max="10000">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">Random Seed</label>
                                                <input type="number" class="form-control" id="seed" value="42" min="0" max="2147483647">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Quantization Settings -->
                                    <h6 class="mt-4 mb-3"><i class="fas fa-compress"></i> Quantization Settings</h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="use-4bit">
                                                <label class="form-check-label" for="use-4bit">
                                                    Use 4-bit <small class="text-muted">(QLoRA)</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="use-8bit">
                                                <label class="form-check-label" for="use-8bit">
                                                    Use 8-bit <small class="text-muted">(INT8)</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">4-bit Compute Type</label>
                                                <select class="form-select form-select-sm" id="bnb-4bit-compute-dtype">
                                                    <option value="float16" selected>Float16</option>
                                                    <option value="bfloat16">BFloat16</option>
                                                    <option value="float32">Float32</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="form-label">4-bit Quant Type</label>
                                                <select class="form-select form-select-sm" id="bnb-4bit-quant-type">
                                                    <option value="nf4" selected>NF4</option>
                                                    <option value="fp4">FP4</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-4">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="use-nested-quant">
                                                <label class="form-check-label" for="use-nested-quant">
                                                    Nested Quantization <small class="text-muted">(Double quantization)</small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step Navigation -->
                            <div class="step-navigation mt-4">
                                <button class="btn btn-outline-secondary" onclick="goToStep(2)">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                                <button class="btn btn-primary ms-auto" onclick="validateAndProceed(3)">
                                    Continue <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Review & Train -->
                <div class="workflow-step" id="step-4">
                    <div class="step-card">
                        <div class="step-header" onclick="toggleStep(4)">
                            <div class="d-flex align-items-center">
                                <span class="step-number">4</span>
                                <h4 class="step-title">Review & Train</h4>
                                <span class="step-status ms-auto">
                                    <i class="fas fa-chevron-down" id="step-4-chevron"></i>
                                </span>
                            </div>
                        </div>
                        <div class="step-content collapse" id="step-4-content">
                            <!-- Model Display Name -->
                            <div class="mb-4">
                                <h5 class="section-title">
                                    <i class="fas fa-tag"></i> Model Name
                                </h5>
                                <div class="form-group">
                                    <input type="text" class="form-control" id="model-display-name"
                                           placeholder="e.g., Math Solver v2 (auto-generated if empty)">
                                    <small class="text-muted">Give your trained model a memorable name for easy identification. This name will be used for both training and exports.</small>
                                </div>
                            </div>

                            <!-- Configuration Summary -->
                            <div class="config-summary">
                                <h5 class="section-title">
                                    <i class="fas fa-clipboard-check"></i> Configuration Summary
                                </h5>
                                <div class="summary-grid">
                                    <div class="summary-item">
                                        <span class="summary-label">Model:</span>
                                        <span class="summary-value" id="summary-model">--</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">Dataset:</span>
                                        <span class="summary-value" id="summary-dataset">--</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">Training Time:</span>
                                        <span class="summary-value" id="summary-time">~15 minutes</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">VRAM Required:</span>
                                        <span class="summary-value" id="summary-vram">~4GB</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">Epochs:</span>
                                        <span class="summary-value" id="summary-epochs">--</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">Batch Size:</span>
                                        <span class="summary-value" id="summary-batch">--</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Train Button -->
                            <div class="train-section mt-4">
                                <button class="btn btn-train" onclick="startTraining()" id="train-btn">
                                    <i class="fas fa-dumbbell"></i> Start Training
                                </button>
                            </div>

                            <!-- Progress bar moved to navbar, removing duplicate -->

                            <!-- Training Monitor (Hidden initially) -->
                            <div id="training-monitor" class="training-monitor" style="display: none;">
                                <h5 class="section-title">
                                    <i class="fas fa-chart-line"></i> Training Progress
                                    <small class="text-muted ms-2" style="font-size: 0.7em; font-weight: normal;">
                                        (Detailed metrics update every 10 steps)
                                    </small>
                                </h5>

                                <!-- Metrics Panel -->
                                <div class="metrics-panel mb-3">
                                    <div class="row">
                                        <div class="col-md-2">
                                            <div class="metric-item">
                                                <span class="metric-label">Step</span>
                                                <span class="metric-value" id="metric-step">0</span>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="metric-item">
                                                <span class="metric-label">Loss</span>
                                                <span class="metric-value" id="metric-loss">--</span>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="metric-item">
                                                <span class="metric-label">Reward</span>
                                                <span class="metric-value" id="metric-reward">--</span>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="metric-item">
                                                <span class="metric-label">Grad Norm</span>
                                                <span class="metric-value" id="metric-grad-norm">--</span>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="metric-item">
                                                <span class="metric-label">Learning Rate</span>
                                                <span class="metric-value" id="metric-lr">--</span>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="metric-item">
                                                <span class="metric-label">Epoch</span>
                                                <span class="metric-value" id="metric-epoch">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Charts -->
                                <div class="row">
                                    <div class="col-md-4">
                                        <canvas id="loss-chart"></canvas>
                                    </div>
                                    <div class="col-md-4">
                                        <canvas id="reward-chart"></canvas>
                                    </div>
                                    <div class="col-md-4">
                                        <canvas id="lr-chart"></canvas>
                                    </div>
                                </div>

                                <!-- Training Logs -->
                                <div class="training-logs mt-3">
                                    <div class="logs-header">
                                        <span>Training Logs</span>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                                            Clear
                                        </button>
                                    </div>
                                    <div id="training-logs" class="logs-content"></div>
                                </div>

                                <!-- Training Controls -->
                                <div class="training-controls mt-3">
                                    <button class="btn btn-warning" onclick="pauseTraining()" id="pause-btn">
                                        <i class="fas fa-pause"></i> Pause
                                    </button>
                                    <button class="btn btn-danger" onclick="stopTraining()" id="stop-btn">
                                        <i class="fas fa-stop"></i> Stop
                                    </button>
                                </div>
                            </div>

                            <!-- Step Navigation -->
                            <div class="step-navigation mt-4" id="step-4-nav">
                                <button class="btn btn-outline-secondary" onclick="goToStep(3)">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Exports Management -->
                <div class="workflow-step" id="step-5">
                    <div class="step-card">
                        <div class="step-header" onclick="toggleStep(5)">
                            <div class="d-flex align-items-center">
                                <span class="step-number">5</span>
                                <h4 class="step-title">Model Exports</h4>
                                <span class="step-status ms-auto">
                                    <i class="fas fa-chevron-down" id="step-5-chevron"></i>
                                </span>
                            </div>
                        </div>
                        <div class="step-content collapse" id="step-5-content">
                            <!-- Exports Controls -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="section-title mb-0">
                                    <i class="fas fa-history"></i> Trained Models & Exports
                                </h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshTrainedModels()">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="showBatchExport()">
                                        <i class="fas fa-file-archive"></i> Batch Export
                                    </button>
                                </div>
                            </div>

                            <div class="row">
                                <!-- Left Column: Trained Models -->
                                <div class="col-lg-8">
                                    <div class="models-section">
                                        <h6 class="fw-bold mb-3">
                                            <i class="fas fa-brain"></i> Available Models
                                        </h6>
                                        <div id="trained-models-list" class="models-list">
                                            <!-- Model cards will be populated here -->
                                            <div class="text-center text-muted p-4">
                                                <i class="fas fa-spinner fa-spin"></i> Loading models...
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Column: Export History -->
                                <div class="col-lg-4">
                                    <div class="exports-section">
                                        <h6 class="fw-bold mb-3">
                                            <i class="fas fa-file-export"></i> Recent Exports
                                        </h6>
                                        <div id="export-history-list" class="export-history">
                                            <!-- Export history will be populated here -->
                                            <div class="text-center text-muted p-4">
                                                <p class="mb-0">No exports yet</p>
                                                <small>Exported models will appear here</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Model Details Panel (Hidden by default) -->
                            <div id="model-details-panel" class="model-details mt-4" style="display: none;">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-info-circle"></i> Model Details
                                        </h6>
                                        <button type="button" class="btn-close float-end" onclick="hideModelDetails()"></button>
                                    </div>
                                    <div class="card-body" id="model-details-content">
                                        <!-- Details will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Step Navigation -->
                            <div class="step-navigation mt-4" id="step-5-nav">
                                <button class="btn btn-outline-secondary" onclick="goToStep(4)">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                                <button class="btn btn-primary ms-2" onclick="goToStep(1)">
                                    <i class="fas fa-plus"></i> Train New Model
                                </button>
                                <button class="btn btn-success ms-2" onclick="goToStep(6)">
                                    <i class="fas fa-vial"></i> Test Model
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 6: Test Model -->
                <div class="workflow-step" id="step-6">
                <div class="step-card">
                    <div class="step-header" onclick="toggleStep(6)">
                        <div class="d-flex align-items-center">
                            <span class="step-number">6</span>
                            <h4 class="step-title">Test Model</h4>
                            <span class="step-status ms-auto">
                                <i class="fas fa-chevron-down" id="step-6-chevron"></i>
                            </span>
                        </div>
                    </div>
                    <div class="step-content collapse" id="step-6-content">
                        <!-- Model Testing Section -->
                        <div class="model-testing-section p-4">
                            <h5 class="section-title mb-4">
                                <i class="fas fa-balance-scale"></i> Model Comparison
                            </h5>

                            <!-- Tab Navigation -->
                            <ul class="nav nav-tabs mb-4" id="testModeTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="single-test-tab" data-bs-toggle="tab" data-bs-target="#single-test" type="button" role="tab">
                                        <i class="fas fa-comment"></i> Single Test
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="batch-test-tab" data-bs-toggle="tab" data-bs-target="#batch-test" type="button" role="tab">
                                        <i class="fas fa-file-csv"></i> Batch Test
                                    </button>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content" id="testModeContent">
                                <!-- Single Test Tab -->
                                <div class="tab-pane fade show active" id="single-test" role="tabpanel">
                            <!-- Model Selection -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h6 class="card-title fw-bold mb-3">
                                        <i class="fas fa-robot"></i> Model Selection
                                    </h6>

                                    <!-- Comparison Mode -->
                                    <div class="comparison-mode mb-3">
                                        <label class="form-label fw-semibold">Comparison Mode</label>
                                        <div class="btn-group w-100" role="group" aria-label="Comparison mode">
                                            <input type="radio" class="btn-check" name="comparison-mode" id="compare-base" value="base" checked onchange="toggleComparisonMode()">
                                            <label class="btn btn-outline-primary" for="compare-base">
                                                <i class="fas fa-cube"></i> Compare with Base Model
                                            </label>
                                            <input type="radio" class="btn-check" name="comparison-mode" id="compare-model" value="model" onchange="toggleComparisonMode()">
                                            <label class="btn btn-outline-primary" for="compare-model">
                                                <i class="fas fa-exchange-alt"></i> Compare with Another Model
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Primary Model Selection -->
                                    <div class="primary-model-section mb-3">
                                        <div class="row">
                                            <div class="col-12">
                                                <label class="form-label fw-semibold">
                                                    <i class="fas fa-star"></i> Primary Model
                                                </label>
                                                <select class="form-select" id="test-model-select" onchange="updateModelInfo()">
                                                    <option value="">Loading models...</option>
                                                </select>
                                                <div class="mt-2">
                                                    <div id="model-info" class="text-muted small">
                                                        <i class="fas fa-info-circle"></i> No model selected
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Comparison Model Selection (for model-to-model comparison) -->
                                    <div class="comparison-model-section mb-3" id="second-model-section" style="display: none;">
                                        <hr class="my-3">
                                        <div class="row">
                                            <div class="col-12">
                                                <label class="form-label fw-semibold">
                                                    <i class="fas fa-exchange-alt"></i> Comparison Model
                                                </label>
                                                <select class="form-select" id="comparison-model-select" onchange="updateComparisonModelInfo()">
                                                    <option value="">Select a model to compare against...</option>
                                                </select>
                                                <div class="mt-2">
                                                    <div id="comparison-model-info" class="text-muted small">
                                                        <i class="fas fa-info-circle"></i> No comparison model selected
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Load from Path (Optional) -->
                                    <div class="load-path-section border-top pt-3 mb-3">
                                        <div class="row">
                                            <div class="col-12">
                                                <label class="form-label text-muted">
                                                    <i class="fas fa-folder-open"></i> Or Load from Custom Path
                                                </label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="custom-model-path"
                                                           placeholder="./outputs/session_id/checkpoints/final">
                                                    <button class="btn btn-outline-secondary" type="button" onclick="loadFromPath()">
                                                        <i class="fas fa-folder-open"></i> Load
                                                    </button>
                                                </div>
                                                <small class="text-muted">Enter path to model checkpoint</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="mt-3 d-flex justify-content-between align-items-center">
                                        <!-- Loaded Models Status -->
                                        <div id="loaded-models-status" style="display: none;">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-check-circle text-success me-2"></i>
                                                <small class="text-muted">Loaded:</small>
                                                <span class="badge bg-success ms-2" id="loaded-trained-badge">-</span>
                                                <span class="mx-1 text-muted">vs</span>
                                                <span class="badge bg-info" id="loaded-base-badge">-</span>
                                            </div>
                                        </div>

                                        <!-- Clear Cache Button -->
                                        <div class="d-flex">
                                            <button class="btn btn-outline-secondary w-100" onclick="clearModelCache()">
                                                <i class="fas fa-broom"></i> Clear Cache
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Test Configuration -->
                            <div class="generation-config mb-4">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-cog"></i> Generation Settings
                                </h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label">Temperature</label>
                                        <input type="range" class="form-range" id="test-temperature" min="0" max="2" step="0.1" value="0.7">
                                        <small class="text-muted">Value: <span id="test-temp-value">0.7</span></small>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Max Tokens</label>
                                        <input type="number" class="form-control" id="test-max-tokens" value="512" min="32" max="2048">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Top P</label>
                                        <input type="range" class="form-range" id="test-top-p" min="0" max="1" step="0.05" value="0.95">
                                        <small class="text-muted">Value: <span id="test-top-p-value">0.95</span></small>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Repetition Penalty</label>
                                        <input type="range" class="form-range" id="test-rep-penalty" min="0.5" max="2" step="0.1" value="1.0">
                                        <small class="text-muted">Value: <span id="test-rep-value">1.0</span></small>
                                    </div>
                                </div>
                            </div>

                            <!-- Test Prompt -->
                            <div class="test-prompt mb-4">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-edit"></i> Test Prompt
                                </h6>
                                <textarea class="form-control" id="test-prompt" rows="4" placeholder="Enter your test prompt here...">What is 25 * 47?</textarea>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="use-chat-template" checked>
                                    <label class="form-check-label" for="use-chat-template">
                                        Use chat template
                                    </label>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-success btn-lg w-100" onclick="compareModels()" id="compare-btn">
                                        <i class="fas fa-play"></i> Compare Models
                                    </button>
                                </div>
                            </div>

                            <!-- Comparison Results -->
                            <div class="comparison-results" id="comparison-results" style="display: none;">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-chart-bar"></i> Results
                                </h6>
                                <div class="row">
                                    <!-- Trained Model Response -->
                                    <div class="col-lg-6 mb-3">
                                        <div class="card border-success">
                                            <div class="card-header bg-success text-white">
                                                <i class="fas fa-graduation-cap"></i> <span id="primary-model-name">Trained Model</span>
                                                <span class="badge bg-white text-success float-end" id="trained-time">-</span>
                                            </div>
                                            <div class="card-body">
                                                <div class="response-content" id="trained-response">
                                                    <div class="text-center text-muted p-3">
                                                        <i class="fas fa-hourglass"></i> Waiting for response...
                                                    </div>
                                                </div>
                                                <div class="mt-2 small text-muted">
                                                    Tokens: <span id="trained-tokens">-</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Base Model Response -->
                                    <div class="col-lg-6 mb-3">
                                        <div class="card border-primary">
                                            <div class="card-header bg-primary text-white" id="comparison-card-header">
                                                <i class="fas fa-cube" id="comparison-icon"></i> <span id="comparison-model-name">Base Model</span>
                                                <span class="badge bg-white text-primary float-end" id="base-time">-</span>
                                            </div>
                                            <div class="card-body">
                                                <div class="response-content" id="base-response">
                                                    <div class="text-center text-muted p-3">
                                                        <i class="fas fa-hourglass"></i> Waiting for response...
                                                    </div>
                                                </div>
                                                <div class="mt-2 small text-muted">
                                                    Tokens: <span id="base-tokens">-</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Comparison Metrics -->
                                <div class="comparison-metrics card mt-3">
                                    <div class="card-body">
                                        <h6 class="fw-bold">Comparison Metrics</h6>
                                        <div class="row text-center">
                                            <div class="col-md-3">
                                                <div class="metric">
                                                    <div class="metric-value" id="length-diff">-</div>
                                                    <div class="metric-label">Length Difference</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="metric">
                                                    <div class="metric-value" id="time-diff">-</div>
                                                    <div class="metric-label">Time Difference</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="metric">
                                                    <div class="metric-value" id="trained-quality">-</div>
                                                    <div class="metric-label">Trained Quality</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="metric">
                                                    <div class="metric-value" id="base-quality">-</div>
                                                    <div class="metric-label">Base Quality</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Test History -->
                                <div class="test-history mt-4">
                                    <h6 class="fw-bold mb-3">
                                        <i class="fas fa-history"></i> Test History
                                    </h6>
                                    <div id="test-history-list" class="list-group">
                                        <!-- Test history will be populated here -->
                                    </div>
                                </div>
                            </div>
                                </div>
                                <!-- End Single Test Tab -->

                                <!-- Batch Test Tab -->
                                <div class="tab-pane fade" id="batch-test" role="tabpanel">
                                    <!-- Model Selection for Batch Test -->
                                    <div class="card mb-4">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold mb-3">
                                                <i class="fas fa-robot"></i> Model Selection
                                            </h6>

                                            <!-- Primary Model Selection -->
                                            <div class="mb-3">
                                                <label class="form-label">Primary Model (Trained)</label>
                                                <select class="form-select" id="batch-test-model-select" onchange="updateBatchModelSelection()">
                                                    <option value="">Select a trained model...</option>
                                                </select>
                                                <small class="text-muted">Select the trained model to test</small>
                                            </div>

                                            <!-- Comparison Mode -->
                                            <div class="mb-3">
                                                <label class="form-label">Comparison Mode</label>
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="batch-compare-mode" id="batch-compare-base" value="base" checked>
                                                    <label class="btn btn-outline-primary" for="batch-compare-base">
                                                        <i class="fas fa-cube"></i> Compare with Base Model
                                                    </label>
                                                    <input type="radio" class="btn-check" name="batch-compare-mode" id="batch-compare-model" value="model">
                                                    <label class="btn btn-outline-primary" for="batch-compare-model">
                                                        <i class="fas fa-layer-group"></i> Compare with Another Model
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- Base Model Selection (shown when comparing with base) -->
                                            <div class="mb-3" id="batch-base-model-group">
                                                <label class="form-label">Base Model</label>
                                                <input type="text" class="form-control" id="batch-base-model-input" readonly>
                                                <small class="text-muted">Automatically set from selected trained model</small>
                                            </div>

                                            <!-- Comparison Model Selection (shown when comparing with another model) -->
                                            <div class="mb-3" id="batch-comparison-model-group" style="display: none;">
                                                <label class="form-label">Comparison Model</label>
                                                <select class="form-select" id="batch-comparison-model-select">
                                                    <option value="">Select another trained model...</option>
                                                </select>
                                                <small class="text-muted">Select another trained model for comparison</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- File Upload Section -->
                                    <div class="card mb-4">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold mb-3">
                                                <i class="fas fa-file-upload"></i> Upload Test File
                                            </h6>
                                            <div class="mb-3">
                                                <input type="file" class="form-control" id="batch-test-file" accept=".csv,.json,.jsonl" onchange="handleBatchTestFileUpload()">
                                                <small class="text-muted">Supported formats: CSV, JSON, JSONL</small>
                                            </div>
                                            <div id="batch-file-info" class="alert alert-info" style="display: none;">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span id="batch-file-details"></span>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="clearBatchTestFile()">
                                                        <i class="fas fa-times"></i> Clear
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Column Configuration -->
                                    <div class="card mb-4" id="batch-column-config" style="display: none;">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold mb-3">
                                                <i class="fas fa-columns"></i> Column Configuration
                                            </h6>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label class="form-label">Instruction Column</label>
                                                    <select class="form-select" id="batch-instruction-column">
                                                        <option value="">Select column...</option>
                                                    </select>
                                                    <small class="text-muted">Column containing test prompts</small>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Expected Response Column (Optional)</label>
                                                    <select class="form-select" id="batch-response-column">
                                                        <option value="">None - Just compare models</option>
                                                    </select>
                                                    <small class="text-muted">For evaluation against expected outputs</small>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Sample Size</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="batch-sample-size" min="1" placeholder="All">
                                                        <span class="input-group-text" id="batch-total-samples">of 0</span>
                                                    </div>
                                                    <small class="text-muted">Leave empty to use all samples</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Test Options -->
                                    <div class="card mb-4" id="batch-test-options" style="display: none;">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold mb-3">
                                                <i class="fas fa-cog"></i> Test Options
                                            </h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="batch-use-chat-template" checked>
                                                        <label class="form-check-label" for="batch-use-chat-template">
                                                            Use chat template
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="batch-evaluate-responses">
                                                        <label class="form-check-label" for="batch-evaluate-responses">
                                                            Calculate evaluation metrics
                                                        </label>
                                                        <small class="text-muted d-block">Requires expected response column</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <button class="btn btn-success btn-lg w-100" onclick="runBatchComparison()" id="batch-compare-btn" disabled>
                                                    <i class="fas fa-play"></i> Run Batch Comparison
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Batch Results -->
                                    <div class="card" id="batch-results" style="display: none;">
                                        <div class="card-body">
                                            <h6 class="card-title fw-bold mb-3">
                                                <i class="fas fa-chart-bar"></i> Batch Test Results
                                            </h6>

                                            <!-- Progress Bar -->
                                            <div class="progress mb-3" id="batch-progress" style="display: none;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                            </div>

                                            <!-- Summary Statistics -->
                                            <div class="row mb-4" id="batch-summary" style="display: none;">
                                                <div class="col-md-3">
                                                    <div class="text-center">
                                                        <h4 id="batch-accuracy">-</h4>
                                                        <small class="text-muted">Accuracy</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-center">
                                                        <h4 id="batch-avg-length">-</h4>
                                                        <small class="text-muted">Avg Response Length</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-center">
                                                        <h4 id="batch-avg-time">-</h4>
                                                        <small class="text-muted">Avg Time (s)</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-center">
                                                        <h4 id="batch-total-samples">-</h4>
                                                        <small class="text-muted">Samples Tested</small>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Results Table -->
                                            <div class="table-responsive">
                                                <table class="table table-sm" id="batch-results-table">
                                                    <thead>
                                                        <tr>
                                                            <th>#</th>
                                                            <th>Instruction</th>
                                                            <th>Trained Model</th>
                                                            <th>Comparison Model</th>
                                                            <th id="expected-header">Expected Response</th>
                                                            <th id="match-header">Match</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="batch-results-body">
                                                        <!-- Results will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>

                                            <!-- Export Button -->
                                            <div class="mt-3">
                                                <button class="btn btn-success" onclick="exportBatchResults()">
                                                    <i class="fas fa-download"></i> Export Results as CSV
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- End Batch Test Tab -->
                            </div>
                            <!-- End Tab Content -->
                        </div>
                    </div>
                </div>
                <!-- End of Step 6 -->

                <!-- Step 7: Evaluate Model -->
                <div class="workflow-step" id="step-7" style="display: none;">
                    <div class="step-card">
                        <div class="step-header">
                            <div class="d-flex align-items-center">
                                <span class="step-number">7</span>
                                <div class="ms-3">
                                    <h5 class="mb-0">Model Evaluation</h5>
                                    <small class="text-muted">Test model accuracy with labeled data</small>
                                </div>
                            </div>
                        </div>
                        <div class="step-content">
                            <div class="row">
                                <!-- Model Selection -->
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6><i class="fas fa-brain"></i> Select Model to Evaluate</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">Trained Model</label>
                                                <select class="form-select" id="eval-model-select" onchange="updateEvalModelInfo()">
                                                    <option value="">Select a model...</option>
                                                </select>
                                            </div>
                                            <div id="eval-model-info" class="small text-muted"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Test Data Upload -->
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6><i class="fas fa-file-csv"></i> Upload Test Data</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">CSV File with Test Cases</label>
                                                <input type="file" class="form-control" id="eval-test-file" accept=".csv" onchange="handleEvalFileUpload()">
                                                <small class="form-text text-muted">
                                                    CSV should contain 'input' and 'expected_output' columns
                                                </small>
                                            </div>
                                            <div id="eval-file-info" class="small text-muted"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Evaluation Configuration -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6><i class="fas fa-cog"></i> Evaluation Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Input Column</label>
                                            <input type="text" class="form-control" id="eval-input-column" value="input" placeholder="input">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Expected Output Column</label>
                                            <input type="text" class="form-control" id="eval-output-column" value="expected_output" placeholder="expected_output">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Max Samples</label>
                                            <input type="number" class="form-control" id="eval-max-samples" value="100" min="1" max="1000">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <label class="form-label">Evaluation Prompt Template</label>
                                            <textarea class="form-control" id="eval-prompt-template" rows="3" placeholder="Optional: {input} will be replaced with test input">{input}</textarea>
                                            <small class="form-text text-muted">Use {input} as placeholder for test input</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Run Evaluation -->
                            <div class="text-center mb-3">
                                <button class="btn btn-primary btn-lg" id="run-eval-btn" onclick="runEvaluation()" disabled>
                                    <i class="fas fa-play"></i> Run Evaluation
                                </button>
                            </div>

                            <!-- Evaluation Results -->
                            <div class="card" id="eval-results" style="display: none;">
                                <div class="card-header">
                                    <h6><i class="fas fa-chart-bar"></i> Evaluation Results</h6>
                                </div>
                                <div class="card-body">
                                    <!-- Summary Stats -->
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <h4 id="eval-accuracy">-</h4>
                                                <small class="text-muted">Accuracy</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <h4 id="eval-precision">-</h4>
                                                <small class="text-muted">Precision</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <h4 id="eval-recall">-</h4>
                                                <small class="text-muted">Recall</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <h4 id="eval-f1">-</h4>
                                                <small class="text-muted">F1 Score</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Detailed Results Table -->
                                    <div class="table-responsive">
                                        <table class="table table-sm" id="eval-details-table">
                                            <thead>
                                                <tr>
                                                    <th>Input</th>
                                                    <th>Expected</th>
                                                    <th>Model Output</th>
                                                    <th>Match</th>
                                                </tr>
                                            </thead>
                                            <tbody id="eval-details-body">
                                                <!-- Results will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Export Results -->
                                    <div class="mt-3">
                                        <button class="btn btn-success btn-sm" onclick="exportEvalResults()">
                                            <i class="fas fa-download"></i> Export Results as CSV
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End of Step 7 -->
            </div>
            <!-- End of content-container -->
        </main>
        <!-- End of content-area -->
    </div>
    <!-- End of main-wrapper -->

    <!-- Modals -->
    <!-- System Info Modal -->
    <div class="modal fade" id="systemInfoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">System Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="system-info-content">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Template Modal -->
    <div class="modal fade" id="saveTemplateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Prompt Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Template Name</label>
                        <input type="text" class="form-control" id="template-name-input" placeholder="Enter template name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (optional)</label>
                        <textarea class="form-control" id="template-description-input" rows="2" placeholder="Enter template description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTemplateFromModal()">Save Template</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dataset Preview Modal -->
    <div class="modal fade" id="datasetPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Dataset Preview: <span id="preview-dataset-name"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="dataset-preview-loading" class="text-center p-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading dataset samples...</p>
                    </div>
                    <div id="dataset-preview-content" style="display: none;">
                        <div class="mb-3">
                            <h6>Dataset Statistics</h6>
                            <div id="dataset-stats" class="alert alert-light"></div>
                        </div>
                        <div>
                            <h6>Sample Data</h6>
                            <div id="dataset-samples"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="use-dataset-btn" onclick="useDatasetFromPreview()">Use This Dataset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dataset Download Progress Modal -->
    <div class="modal fade" id="downloadProgressModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Downloading Dataset</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>Dataset:</strong> <span id="downloading-dataset-name"></span>
                    </div>
                    <div class="loading-spinner-container">
                        <div class="loading-spinner"></div>
                        <div id="download-status-message" class="loading-message">
                            Initializing download...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cancelDownload()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle"></i> <span id="delete-confirm-title">Confirm Delete</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-trash-alt text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <div id="delete-confirm-message" class="text-center">
                        Are you sure you want to delete this item?
                    </div>
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-circle"></i> This action cannot be undone!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-danger" id="delete-confirm-btn">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- App Info Modal -->
    <div class="modal fade" id="appInfoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle"></i> About LoRA Craft
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12 text-center mb-4">
                            <img src="{{ url_for('static', filename='images/lora_craft.png') }}" alt="LoRA Craft" style="width: 100px; height: 100px;">
                            <h3 class="mt-3">LoRA Craft</h3>
                            <p class="text-muted">GPRO/GSPO LoRA Fine-Tuning Crafting Interface</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-rocket"></i> Features</h6>
                            <ul class="small">
                                <li>Advanced GRPO/GSPO training algorithms</li>
                                <li>Support for multiple model families</li>
                                <li>Real-time training monitoring</li>
                                <li>Model comparison and testing</li>
                                <li>Multiple export formats (GGUF, SafeTensors, etc.)</li>
                                <li>Custom dataset support</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-cog"></i> System Info</h6>
                            <ul class="small">
                                <li>Version: 2025.09.28</li>
                                <li>Framework: Flask + Socket.IO</li>
                                <li>ML Backend: Transformers + Unsloth</li>
                                <li>GPU Support: CUDA-enabled</li>
                                <li>License: MIT</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/enhanced_rewards.js') }}"></script>
</body>
</html>
